// Jenkinsfile de ejemplo para Angular con Docker
pipeline {
    agent any
    
    environment {
        // Configuraci√≥n de Docker
        IMAGE_NAME = 'my-angular-app'
        DOCKER_REGISTRY = 'docker.io/myuser'
        IMAGE_TAG = "${env.BUILD_NUMBER}"
        // Configuraci√≥n de ambientes
        STAGING_PORT = '8080'
        PROD_PORT = '80'
    }
    
    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['staging', 'production'],
            description: 'Ambiente de despliegue'
        )
        booleanParam(
            name: 'RUN_TESTS',
            defaultValue: true,
            description: 'Ejecutar tests'
        )
        booleanParam(
            name: 'SECURITY_SCAN',
            defaultValue: true,
            description: 'Ejecutar escaneo de seguridad'
        )
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üì• Descargando c√≥digo'
                checkout scm
            }
        }
        
        stage('CI - Build & Test') {
            steps {
                script {
                    // Cargar scripts CI
                    def ci = load 'pipelines/angular/ci.groovy'
                    
                    // Instalar dependencias
                    ci.install()
                    
                    // Linter
                    ci.lint()
                    
                    // Tests
                    if (params.RUN_TESTS) {
                        ci.test()
                    }
                    
                    // Build
                    ci.build(params.ENVIRONMENT)
                    
                    // Construir imagen Docker
                    ci.buildDockerImage(IMAGE_NAME, IMAGE_TAG)
                    
                    // Escaneo de seguridad
                    if (params.SECURITY_SCAN) {
                        ci.runSecurityScan(IMAGE_NAME, IMAGE_TAG)
                    }
                }
            }
        }
        
        stage('Push to Registry') {
            when {
                branch 'main'
            }
            steps {
                script {
                    def ci = load 'pipelines/angular/ci.groovy'
                    
                    // Login a Docker registry
                    withCredentials([usernamePassword(
                        credentialsId: 'docker-credentials',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh 'echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin'
                    }
                    
                    // Push imagen
                    ci.pushDockerImage("${DOCKER_REGISTRY}/${IMAGE_NAME}", IMAGE_TAG)
                }
            }
        }

        stage('CD - Deploy') {
            steps {
                script {
                    // Cargar scripts CD
                    def cd = load 'pipelines/angular/cd.groovy'
                    
                    // Determinar puerto seg√∫n ambiente
                    def port = params.ENVIRONMENT == 'production' ? PROD_PORT : STAGING_PORT
                    
                    // Desplegar
                    cd.deployToDocker(
                        params.ENVIRONMENT,
                        IMAGE_NAME,
                        IMAGE_TAG,
                        port
                    )
                    
                    // Health check
                    cd.healthCheck("http://localhost:${port}")
                    
                    // Limpiar im√°genes antiguas
                    cd.cleanOldImages(IMAGE_NAME, 3)
                }
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ Pipeline ejecutado exitosamente'
            // Notificaci√≥n (Slack, email, etc.)
        }
        failure {
            echo '‚ùå Pipeline fall√≥'
            script {
                def cd = load 'pipelines/angular/cd.groovy'
                // Rollback autom√°tico en caso de fallo
                cd.rollback(params.ENVIRONMENT)
            }
        }
        always {
            echo 'üßπ Limpiando workspace'
            cleanWs()
        }
    }
}
